<html>

<head>

    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">


    <link rel="stylesheet" href="https://unpkg.com/formiojs@3.10.0/dist/formio.full.min.css">
    <script src="https://unpkg.com/formiojs@3.10.0/dist/formio.full.min.js"></script>



    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
</head>

<body>
    <script type="text/javascript">

        /**
         * Get the base component class by referencing Formio.Components.components map.
         */
        var BaseComponent = Formio.Components.components.base;

        /**
         * Create a new CheckMatrixComponent "class" using ES5 class inheritance notation. 
         * https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/Inheritance
         * 
         * Here we will derive from the base component which all Form.io form components derive from.
         *
         * @param component
         * @param options
         * @param data
         * @constructor
         */
        function CheckMatrixComponent(component, options, data) {
            console.log('data ', data);
            BaseComponent.prototype.constructor.call(this, component, options, data);
        }

        // Perform typical ES5 inheritance
        CheckMatrixComponent.prototype = Object.create(BaseComponent.prototype);
        CheckMatrixComponent.prototype.constructor = CheckMatrixComponent;

        /**
         * Define what the default JSON schema for this component is. We will derive from the BaseComponent
         * schema and provide our overrides to that.
         * @return {*}
         */
        CheckMatrixComponent.schema = function () {
            return BaseComponent.schema({
                type: 'checkmatrix',
                numRows: 3,
                numCols: 3
            });
        };

        /**
         * Register this component to the Form Builder by providing the "builderInfo" object.
         * 
         * @type {{title: string, group: string, icon: string, weight: number, documentation: string, schema: *}}
         */
        CheckMatrixComponent.builderInfo = {
            title: 'Check Matrix',
            group: 'basic',
            icon: 'fa fa-table',
            weight: 70,
            documentation: 'http://help.form.io/userguide/#table',
            schema: CheckMatrixComponent.schema()
        };

        /**
         *  Tell the renderer how to build this component using DOM manipulation. 
         */
        CheckMatrixComponent.prototype.build = function () {
            this.element = this.ce('div', {
                class: 'table-responsive'
            });
            this.createLabel(this.element);

            var tableClass = 'table ';
            ['striped', 'bordered', 'hover', 'condensed'].forEach(function (prop) {
                if (this.component[prop]) {
                    tableClass += `table-${prop} `;
                }
            }.bind(this));

            var table = this.ce('table', {
                class: tableClass
            });

            // Build the body.
            var tbody = this.ce('tbody');
            this.inputs = [];
            this.checks = [];
            for (let i = 0; i < this.component.numRows; i++) {
                var tr = this.ce('tr');
                this.checks.push([]);
                for (let j = 0; j < this.component.numCols; j++) {
                    var td = this.ce('td');
                    this.checks[i][j] = this.ce('input', {
                        type: 'checkbox'
                    });
                    this.addInput(this.checks[i][j], td);
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
            table.appendChild(tbody);
            this.element.appendChild(table);
        };

        /**
         * Provide the input element information. Because we are using checkboxes, the change event needs to be 
         * 'click' instead of the default 'change' from the BaseComponent.
         * 
         * @return {{type, component, changeEvent, attr}}
         */
        CheckMatrixComponent.prototype.elementInfo = function () {
            const info = BaseComponent.prototype.elementInfo.call(this);
            info.changeEvent = 'click';
            return info;
        };

        /**
         * Tell the renderer how to "get" a value from this component.
         * 
         * @return {Array}
         */
        CheckMatrixComponent.prototype.getValue = function () {
            var value = [];
            for (var rowIndex in this.checks) {
                var row = this.checks[rowIndex];
                value[rowIndex] = [];
                for (var colIndex in row) {
                    var col = row[colIndex];
                    value[rowIndex][colIndex] = !!col.checked;
                }
            }
            return value;
        };

        /**
         * Tell the renderer how to "set" the value of this component.
         * 
         * @param value
         * @return {boolean}
         */
        CheckMatrixComponent.prototype.setValue = function (value) {

            console.log("setvalue value ",value);
            if (!value) {
                return;
            }
            for (var rowIndex in this.checks) {
                var row = this.checks[rowIndex];
                if (!value[rowIndex]) {
                    break;
                }
                for (var colIndex in row) {
                    var col = row[colIndex];
                    if (!value[rowIndex][colIndex]) {
                        return false;
                    }
                    let checked = value[rowIndex][colIndex] ? 1 : 0;
                    console.log("=checked=",checked);
                    col.value = checked;
                    col.checked = checked;
                }
            }
        };

        // Use the table component edit form.
        CheckMatrixComponent.editForm = Formio.Components.components.table.editForm;

        // Register the component to the Formio.Components registry.
        Formio.Components.addComponent('checkmatrix', CheckMatrixComponent);

    </script>
    <!-- <button id="clicktest">Test</button> -->
    <div class="card card-body bg-light">
        <div id="builder"></div>
    </div>
    <h4>Rendered Form</h4>
    <div class="card card-body bg-light">
        <div id="formio"></div>
    </div>
    <h4>Submission Data</h4>
    <div class="card card-body bg-light jsonviewer">
        <pre id="json"></pre>
    </div>
    <script type="text/javascript">
        Formio.builder(document.getElementById('builder'), {}, {
        }).then(function (builder) {

            
           Formio.createForm(document.getElementById('formio'), {}).then(function (instance) {

                var json = document.getElementById('json');
                instance.on('change', function () {
                    json.innerHTML = '';
                    json.appendChild(document.createTextNode(JSON.stringify(instance.submission, null, 4)));
                });
                builder.on('change', function (schema) {
                    if (schema.components) {
                        instance.form = schema;
                    }

                    console.log("FORM::",instance);
                });

                instance.on('submit', function (evt) {

                    console.log("Submission=> ", evt);
                    // debugger

                });



                $('#clicktest').click(function(){

                    console.log('Test',instance);
                     instance.submission.data['textField'] = "Yo";
                     instance.submission.data['select']= '';
                    // console.log(instance.setSubmission(instance.submission));
                    // console.log("sub: ",instance.submission)

                    console.log("ROOT:",instance.root);

                    instance.root.setValue();
                    instance.root.loading = true;
                    instance.root.loading = false;

                    console.log("ROOT::",instance.root.getValue());

                    console.log("Builder:: ",builder);
                    console.log("FormioUtils::",FormioUtils);


                    test = FormioUtils.findComponents(builder.schema.components,{"key": 'textField'})
                    flatten = FormioUtils.flattenComponents(builder.schema.components)

                    // console.log("Test => ",test);
                    // test[0].setValue("sdfsdf")

                    FormioUtils.eachComponent(builder.schema.components,function(component){

                        console.log("XXX",component);
                    })


                    // console.log("Flatten:: ",flatten);

                    

                    // console.log(instance.component.components['0'].setValue('Test'));

                    console.log("OK DONE!!!");

                    });
            });
        });
    </script>
</body>

</html>

